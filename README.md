

#!/bin/bash DATE=`date +%Y%m%d` DEST=$DATE"-all-dbs.sql.gz" CAS_USER=cas OV_USER=oficinavirtual LOCAL_DB_PORT=5433 LOCAL_DB_NAME=ov_db PROD_DB_NAME=oficinavirtual_db echo "Downloading the today sqldump file from OV, the result will be: "$DEST scp somdevel@192.168.1.51:/mnt/backups/$DEST . echo "Dump file downloaded!" echo "CREATE USER $CAS_USER" | psql -h localhost -p $LOCAL_DB_PORT -U $OV_USER -d postgres -W echo "CREATE DATABASE $LOCAL_DB_NAME OWNER $OV_USER" | psql -h localhost -p $LOCAL_DB_PORT -U $OV_USER -d oficinavirtual -W # Exclude SET users db password and dump tables from db in LOCAL_DB_NAME, not in PROD_DB_NAME zcat $DEST | grep -I -v PASSWORD | sed "s/$PROD_DB_NAME/$LOCAL_DB_NAME/g" | psql -h localhost -p $LOCAL_DB_PORT -U $OV_USER -d $LOCAL_DB_NAME -W # password = somhi1234 echo "UPDATE auth_user SET password='pbkdf2_sha256\$36000\$lYejmo8cldY2\$ME07zJPAnRGrmfqLVfj9/bd6m/YF1UEFpxxVIhjneu0='" | psql -h localhost -p $LOCAL_DB_PORT -U $OV_USER -d $LOCAL_DB_NAME -W echo "UPDATE auth_user SET email='benjami.ramos@somenergia.coop'" | psql -h localhost -p $LOCAL_DB_PORT -U $OV_USER -d $LOCAL_DB_NAME -W

